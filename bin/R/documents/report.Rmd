---
title: "Data analysis report"
date: "`r Sys.Date()`"
author: "RTC Bioinformatics"
url: 
  - "Source Code: https://github.com/agusinac/OmicFlow"
output:
  html_document:
    toc: true
    toc_float: true
    css: styles.css
---

<!-- New class for icon, see styles.css -->
<div class="icon-container">
  <img src="RTC_logo.png" alt="Icon" class="icon">
</div>

```{r setup, include=FALSE} 
knitr::opts_chunk$set(warning = FALSE, 
                      message = FALSE, 
                      echo = FALSE, 
                      results = "asis",
                      fig.width = 10,
                      fig.height = 5,
                      fig.alin = "left"
                      ) 
```

```{r}
plot_tabs <- function(plots, method, label_col, label_row) {
  if (method == "matrix") {
    for(i in 1:nrow(plots)) {
      for(j in 1:ncol(plots)) {
        cat(paste0("\n\n### Plot: ", label_col[i], "-", label_row[j], "\n"))
        print(plots[[i,j]])
        cat("\n")
      }
    }
  }
  if (method == "vector") {
    for (i in 1:length(plots)) {
      cat(paste0("\n\n### Plot: ", label_col[i], "\n"))
      print(plots[[i]])
      cat("\n")
    }
  }
}

```

```{r}
if (!is.null(untrimmed_multiqc)) {
  cat("# untrimmed multiqc report")
  cat(paste0("[LINK to untrimmed mutltiqc report](",untrimmed_multiqc, ")"))
}
```

```{r}
if (!is.null(trimmed_multiqc)) {
  cat("# trimmed multiqc report")
  cat(paste0("[LINK to trimmed mutltiqc report](",trimmed_multiqc, ")"))
}
```
```{r}
if (!is.null(pear_multiqc)) {
  cat("# PEAR multiqc report")
  cat(paste0("[LINK to PEAR mutltiqc report](",pear_multiqc, ")"))
}
```

```{r}
if (!is.null(preprocess_stats)) {
  cat("# Preprocessing step \n")
  cat("Refer to published paper regarding pipeline\n")
  preprocess_stats %>% 
    kableExtra::kbl(caption = "Table 1: Stats from cutadapt and DADA2 denoising") %>%
    kableExtra::kable_classic(full_width = TRUE, html_font = "Calibri")
}
```

# Automated Analysis
```{r}
if (!is.null(rankstat_plot)) {
  cat("## Rank stats \n")
  rankstat_plot
}
```


```{r}
if (!is.null(shannon_plots)) {
  cat("## Alpha diversity {.tabset} \n")
  plot_tabs(shannon_plots, method = "vector", label_col = colnames(RANKSTAT_data))
}

```


```{r}
if (!is.null(pcoa_plots)) {
  cat("## Beta Diversity: Principal Coordinate Analysis (PCoA) {.tabset}")
  plot_tabs(pcoa_plots, 
            method = "matrix", 
            label_col = colnames(RANKSTAT_data),
            label_row = metrics)
}

```


```{r}
if (!is.null(nmds_plots)) {
  cat("## Beta Diversity: NMDS {.tabset} \n")
  plot_tabs(nmds_plots, 
            method = "matrix",
            label_col = colnames(RANKSTAT_data),
            label_row = metrics)
}
```



```{r}
if (!is.null(composition_plots)) {
  cat("## Composition {.tabset} \n")
  plot_tabs(composition_plots, 
            method = "matrix", 
            label_col = colnames(RANKSTAT_data), 
            label_row = taxa_names)
}

```


```{r}
if (!is.null(correlation_heatmap_plt)) {
  cat("## Correlations {.tabset} \n")
  plot_tabs(correlation_heatmap_plt, 
            method = "vector",
            label_col = taxa_names)
}

```


```{r}
# Unnaming the plot list and saving as a new list
if (!is.null(heatmap_plots)) {
  cat("## 2-fold heatmap {.tabset} \n")
  
  final_plots <- list()
  fold_headers <- c("boxplot", "barplot", "tile_plot", "rel_abun")
  for (i in 2:length(heatmap_plots[[1]])) {
    final_plots[[i-1]] <- unname(heatmap_plots[[1]][fold_headers[i-1]])
  }
  
  # Separate function due to `[[1]]` being printed to stdout
  for (i in 1:length(final_plots)) {
    cat(paste0("\n\n### Plot ", fold_headers[i], "\n"))
    print(final_plots[[i]][[1]])
    cat("\n")
  }
}

```

```{r}
if (!is.null(sankeyplot)) {
  cat("## sankey plot \n")
  knitr::include_graphics(sankeyplot)
}
```

## Downloadable content

```{r}
flatten <- function(plot_list,data_list) {
  for (obj in data_list) {
    
    current_len <- length(plot_list)
    
    # Append from list
    if (is.list(obj)) {
      for (i in seq_along(obj)) {
        plot_list[[current_len + i]] <- obj[[i]]
      } 
    }
    
    # Append from matrix
    if (is.matrix(obj)) {
      for (i in seq_along(obj)) {
        plot_list[[current_len + i]] <- obj[[i]]
      }
    }
  }
  return(plot_list)
}

# # Combine all plot data structures into a single list, e.g.:
# current_plots <- list(rankstat_plot, shannon_plots)
# add_plots <- list(pcoa_plots, nmds_plots, composition_plots, correlation_heatmap_plt, final_plots)
# content <- flatten(current_plots, add_plots)


# Currently only dataframes and static content available
# TO DO: Implement graph sharing, possibly convert it into an interactive shiny document

# Dynamically fetches files/folders for downloadthis
# path_files <- list.files(
#   path = outfile_path,
#   full.names = TRUE
# )

# File/folder absolute paths
# files <- path_files[grepl("\\.\\w+", path_files)]
# folder <- base::setdiff(path_files, files)
# files.filt <- files[grep("\\.(tsv|csv|txt)$", files)]

# Data as content to be used for downloadthis
content <- c(ps)

# Dataframe to be viewed
overview <- data.frame(
  Name = "phyloseq",
           #tools::file_path_sans_ext(base::basename(files.filt)), 
           #base::basename(folder)),
  data_type = "RDS"
                #base::rep("dataframe", length(files.filt)), 
                #base::rep("dir", length(folder)))
)

overview[["Download"]] <- vapply(1:nrow(overview), function(i) {
  data_type <- overview$data_type[i]
  
  extension <- switch(
    data_type,
    "dataframe" = ".xlsx",
    "RDS" = ".rds",
    "plot" = ".png"
  )
  
  if (data_type == "dir") {
    as.character(
      downloadthis::download_dir(
        path = content[[i]],
        output_name = overview$Name[i],
        button_label = "Download",
        button_type = "primary",
        has_icon = TRUE,
        icon = "fa fa-save",
        self_contained = FALSE
      )
    )
    
  } else if (data_type == "dataframe") {
    as.character(
      downloadthis::download_file(
        path = content[[i]],
        output_name = overview$Name[i],
        button_label = "Download",
        button_type = "primary",
        has_icon = TRUE,
        icon = "fa fa-save",
        self_contained = FALSE
      )
    )
      
  } else {
  as.character(
    downloadthis::download_this(
      .data = content[[i]],
      output_name = overview$Name[i],
      output_extension = extension,
      button_label = "Download",
      button_type = "primary",
      icon = "fa fa-save",
      csv2 = FALSE,
      self_contained = TRUE
    )
  )
  }

}, character(1L))

# Creates interactive table
DT::datatable(
  overview,
  escape = FALSE,
  options = list(
    columnDefs = list(
      list(targets = ncol(overview), orderable = FALSE),
      list(targets = "_all", className = "dt-center")
    )
  )
)

```



<!-- ## Redundancy Analysis (RDA) {.tabset} -->
<!-- ```{r, fig.width=10, fig.height=10} -->
<!-- # par(mfrow=c(RANKSTAT_ncol, 2)) -->
<!-- # for (i in 1:RANKSTAT_ncol) { -->
<!-- #   RDA_plots[[i, 1]]() -->
<!-- #   RDA_plots[[i, 2]]() -->
<!-- # } -->

<!-- ``` -->
<!-- ## {-} -->